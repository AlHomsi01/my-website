<!DOCTYPE html>
<html lang="sv" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üõ†Ô∏è Admin ‚Äì Meningar (GitHub Pages)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#eef6ff;padding:20px;text-align:center}
h1{color:#0b5ed7}
textarea{width:90%;max-width:900px;height:260px;font-size:16px;padding:10px;border:2px solid #0b5ed7;border-radius:10px}
.btn{margin:10px;padding:10px 18px;border:none;border-radius:10px;background:#0b5ed7;color:#fff;cursor:pointer}
.btn:hover{background:#093fa1}
.small{font-size:12px;color:#555}
.token{width:90%;max-width:900px;margin:6px auto 14px;display:flex;gap:8px;align-items:center;justify-content:center}
.token input{width:480px;max-width:70%;padding:8px;border:1px solid #bbb;border-radius:8px}
</style>
</head>
<body>
<h1>üõ†Ô∏è Admin ‚Äì Meningar</h1>

<div class="token">
  <label>GitHub Token (PAT):</label>
  <input id="pat" type="password" placeholder="Klistra in PAT (sparas lokalt)"/>
  <button class="btn" onclick="saveToken()">Spara token</button>
  <button class="btn" onclick="clearToken()">Rensa</button>
</div>
<p class="small">Token lagras i din webbl√§sare (localStorage) och skickas endast till GitHubs API f√∂r att uppdatera <code>sentences.json</code>.</p>

<p>En mening per rad:</p>
<textarea id="area"></textarea><br/>
<button class="btn" onclick="saveSentences()">üíæ Spara till GitHub</button>
<button class="btn" onclick="loadSentences()">üîÑ Ladda fr√•n GitHub</button>

<script>
// ======= KONFIG =======
const OWNER  = "AlHomsi";
const REPO   = "my_website";
const BRANCH = "main";
const FILE_PATH = "sentences.json";
const API_BASE = "https://api.github.com";

// ======= TOKEN =======
const patInput = document.getElementById("pat");
(function initToken(){
  const t = localStorage.getItem("gh_pat");
  if(t) patInput.value = t;
})();
function saveToken(){ localStorage.setItem("gh_pat", patInput.value.trim()); alert("Token sparad."); }
function clearToken(){ localStorage.removeItem("gh_pat"); patInput.value=""; alert("Token rensad."); }

function headers(token){
  return {
    "Accept":"application/vnd.github+json",
    "Authorization":"Bearer "+token,
    "X-GitHub-Api-Version":"2022-11-28",
    "Content-Type":"application/json"
  };
}

// ======= L√ÑS FIL =======
async function loadSentences(){
  try{
    const url = `${API_BASE}/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("Kunde inte l√§sa filen: "+res.status);
    const data = await res.json();
    const content = atob(data.content.replace(/\n/g,""));
    const json = JSON.parse(content);
    document.getElementById("area").value = (json.sentences||[]).join("\n");
    alert("L√§st fr√•n GitHub ‚úÖ");
  }catch(e){ alert("Fel: "+e.message); }
}

// ======= SPARA FIL =======
async function saveSentences(){
  const token = localStorage.getItem("gh_pat") || patInput.value.trim();
  if(!token){ alert("Klistra in din GitHub PAT f√∂rst."); return; }

  const text = document.getElementById("area").value.trim();
  const sentences = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const newContent = JSON.stringify({ sentences }, null, 2);

  // 1) H√§mta nuvarande SHA (kr√§vs av GitHub API vid uppdatering)
  const getUrl = `${API_BASE}/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`;
  let sha = null;
  let exists = true;
  const r1 = await fetch(getUrl);
  if(r1.status === 404){ exists = false; }
  else if(!r1.ok){ alert("Kunde inte l√§sa nuvarande fil (status "+r1.status+")"); return; }
  if(exists){
    const j = await r1.json();
    sha = j.sha;
  }

  // 2) PUT nytt inneh√•ll
  const putUrl = `${API_BASE}/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;
  const body = {
    message: "Update sentences.json via admin.html",
    content: btoa(unescape(encodeURIComponent(newContent))), // Base64
    branch: BRANCH
  };
  if(sha) body.sha = sha;

  const r2 = await fetch(putUrl, { method:"PUT", headers: headers(token), body: JSON.stringify(body) });
  if(!r2.ok){
    const t = await r2.text();
    alert("Sparfel: " + r2.status + "\n" + t);
    return;
  }
  alert("‚úÖ Sparat till GitHub!");
}
loadSentences(); // ladda vid start
</script>
</body>
</html>
